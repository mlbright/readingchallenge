<div class="book-detail">
  <div class="breadcrumb">
    <%= link_to "Challenges", challenges_path %> / 
    <%= link_to @challenge.name, challenge_path(@challenge) %> / 
    <%= @book.title %>
  </div>
  
  <div class="book-header">
    <h2><%= @book.title %></h2>
    <p class="book-author">by <%= @book.author %></p>
    <p class="book-user">Added by <%= link_to @book.user.username, user_path(@book.user) %></p>
  </div>

  <div class="book-info">
    <p><strong>Pages:</strong> <%= @book.pages %></p>
    
    <p>
      <strong>Status:</strong> 
      <% if @book.completed? %>
        <span class="badge badge-completed">âœ“ Completed on <%= @book.completion_date.strftime("%B %d, %Y") %></span>
      <% else %>
        <span class="badge badge-in-progress">ðŸ“– In Progress</span>
      <% end %>
      
      <% if @book.exceeds_veto_threshold? %>
        <span class="badge badge-vetoed">ðŸš« Exceeds Veto Threshold (doesn't count)</span>
      <% end %>
    </p>
    
    <% if @book.description.present? %>
      <div class="book-description">
        <strong>Description:</strong>
        <p><%= simple_format(@book.description) %></p>
      </div>
    <% end %>

    <% if @book.url.present? %>
      <% safe_url = safe_book_url(@book.url) %>
      <% if safe_url %>
        <p><strong>Purchase/More Info:</strong> <%= link_to safe_url, safe_url, target: "_blank", rel: "noopener noreferrer" %></p>
      <% end %>
    <% end %>
  </div>

  <div class="voting-section">
    <h3>Veto Status</h3>
    
    <div class="vote-stats">
      <div class="vote-count">
        <span class="veto-count">ï¿½ <%= @book.veto_count %> <%= @book.veto_count == 1 ? 'Veto' : 'Vetos' %></span>
      </div>
    </div>

    <% if logged_in? && current_user != @book.user %>
      <div class="vote-actions">
        <% if @vote %>
          <p>You have vetoed this book.</p>
          <%= button_to "Remove Veto", challenge_book_vote_path(@challenge, @book, @vote), method: :delete, class: "btn btn-small" %>
        <% else %>
          <h4>Veto this book:</h4>
          <%= form_with url: challenge_book_votes_path(@challenge, @book), method: :post, class: "veto-form" do |f| %>
            <%= f.text_area :veto_reason, placeholder: "Provide a reason for vetoing this book (minimum 10 characters)", rows: 4, required: true %>
            <%= f.submit "ðŸš« Submit Veto", class: "btn btn-danger" %>
          <% end %>
        <% end %>
      </div>
    <% elsif logged_in? && current_user == @book.user %>
      <p class="info-message">You cannot veto your own book.</p>
    <% end %>

    <% if @votes.any? %>
      <div class="votes-list">
        <h4>Veto Record:</h4>
        <% @votes.each do |vote| %>
          <div class="veto-entry">
            <div class="veto-header">
              <strong><%= link_to vote.user.username, user_path(vote.user) %></strong>
              <span class="veto-badge">ðŸš« Vetoed</span>
            </div>
            <div class="veto-reason">
              <em>"<%= vote.veto_reason %>"</em>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="book-actions">
    <%= link_to "â† Back to Challenge", @challenge, class: "btn" %>
    <% if logged_in? && current_user == @book.user %>
      <%= link_to "Edit", edit_challenge_book_path(@challenge, @book), class: "btn" %>
      <%= button_to "Delete", challenge_book_path(@challenge, @book), method: :delete, data: { confirm: "Are you sure you want to delete this book?" }, class: "btn btn-danger" %>
    <% end %>
  </div>
</div>
